<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="robots" content="noindex"> 

    <title>Журнал СМС авторизаций</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="/js/jquery-1.12.1.min.js"></script>
    <script src="/js/bootstrap.min.js"          type="text/javascript"></script>

    <script src="/js/moment.min.js"          type="text/javascript"></script>
    <script src="/js/moment.ru.js"          type="text/javascript"></script>

    <script src="/js/bootstrap-datetimepicker.min.js" type="text/javascript" ></script>
    <script src="/js/bs-dtp-tooltips.js" type="text/javascript" ></script>
    <script src="/js/jquery.cookie.js"          type="text/javascript"></script>
    <script src="/js/jquery.jsonrpc.js"          type="text/javascript"></script>
    <script src="/js/jquery.rpcapi.js"           type="text/javascript"></script>

    <link media="all" type="text/css" rel="stylesheet" href="/css/bootstrap.min.css">
    <link media="all" type="text/css" rel="stylesheet" href="/css/bootstrap-datetimepicker.min.css" />
    <link media="all" type="text/css" rel="stylesheet" href="/css/main.css ">
</head>
<body>

<nav class="navbar navbar-default">
  <div class="container-fluid">
   
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="#">Журнал авторизаций</a>
    </div>
   
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">

      <form id="query" class="navbar-form navbar-left" role="form">

        <div class="navbar-left">
          <div class="input-group">
              <span class="input-group-addon"><i class="glyphicon glyphicon-phone"></i></span>
              <input id="phone" type="tel" class="form-control" name="phone" value="" placeholder="Телефон">
          </div>
          <br>
          <div class="input-group">
              <span class="input-group-addon"><i class="glyphicon glyphicon-map-marker"></i></span>
              <input id="ip" type="text" class="form-control" name="ip" value="" placeholder="ip-адрес">
          </div>
        </div>

        <div class="navbar-left">
          <div class='input-group date' id='dtAfter'>
            <input type='text' class="form-control" name="after" placeholder="Авторизован после"/>
            <span class="input-group-addon"><i class="glyphicon glyphicon-calendar"></i>
            </span>
          </div>
          <br>
          <div class='input-group date' id='dtBefore'>
            <input type='text' class="form-control" name="before" placeholder="Авторизован до"/>
            <span class="input-group-addon"><i class="glyphicon glyphicon-calendar"></i>
            </span>
          </div>
        </div>

        <div class='input-group'>
          <select class="form-control" name="by">
            <option>10</option>
            <option>50</option>
            <option>100</option>
            <option value="-1">Все</option>
          </select>
        </div>
        <button type="submit" class="btn btn-default">Показать</button>
        <button type="reset" class="btn btn-default">Очистить</button>
      </form>
      
      <ul class="nav navbar-nav navbar-right">
        <li><a href="#" onClick="sendLogout()">Выход</a></li>
      </ul>      
    </div>
     
  </div>
</nav>
  <div class="container-fluid">
    <div class="row">
      <div class="well table-responsive col-md-8 col-md-offset-2">
        <div id="log" class="form-status"></div>
        <table id="data" class="table table-striped table-hover table-condensed hide">
          <tbody>
            <tr><th>Время авторизации</th><th>Телефон</th><th>IP-адрес</th><th>Статус</th></tr>
          </tbody>
        </table>
        <p id="next" class="text-center hide">
          <button class="btn btn-primary" onClick="sendNext()">Еще</button>
        </p>
      </div>
    </div>
  </div>

    <script type="text/javascript">

      var params;

    function sendLogout() {
      $.cookie('elfire_sso_token', null, { path: '/' });
      location.reload(true);
      return false;
    }

    function getRows(params) {
        var by = params['by'];
        if (!by) by = 10;

      $('#log').html('Загрузка данных...').removeClass('alert-danger').addClass('alert-info');
      $.rpc.api({
        Form:      $('#query'),
        nameSpace: 'Records',
        Method:    'List',
        Params:    params,
        onSuccess: function(result) {
          $('#log').html('');
          if (result.length < params['by'] || params['by'] == -1) {
            // last page => hide "Next" button
            $('#next').addClass('hide');
            if (result.length == 0) {
              $('#log').html('Нет данных');
            }
          }
          $.each(result, function(index, item) {
            var p = $('<tr>');
            p.append($('<td>').text(moment(item.Stamp).format("L LT"))); 
            p.append($('<td>').text(item.Phone));
            p.append($('<td>').text(item.IP));
            p.append($('<td>').text(item.Status));
            $('#data > tbody:last-child').append(p);
          });
          params["offset"] += result.length;
        },
        onError: function(error) {
          $('#log').html('Ошибка: ' + error.message).removeClass('alert-info').addClass('alert-danger');
        }
      });
      return false;
    }

    function sendNext() {
      getRows(params);
    }

    $.ajaxSetup({
      'beforeSend': function(xhr) {
        xhr.setRequestHeader('X-ELFIRE-Token', 'Bearer ' + $.cookie('elfire_sso_token'));
      }
    });
    
    $(function () {
      //Инициализация 
      $("#dtAfter").datetimepicker();
      $("#dtBefore").datetimepicker();
      
      //При изменении даты в dtAfter, она устанавливается как минимальная для dtBefore
      $("#dtAfter").on("dp.change",function (e) {
        $("#dtBefore").data("DateTimePicker").minDate(e.date);
      });
      //При изменении даты в dtBefore, она устанавливается как максимальная для 8dtAfter
      $("#dtBefore").on("dp.change",function (e) {
        $("#dtAfter").data("DateTimePicker").maxDate(e.date);
      });
  
      // http://stackoverflow.com/questions/5448545/how-to-retrieve-get-parameters-from-javascript
      params = decodeURIComponent(window.location.search.slice(1))
        .split('&')
        .reduce(function _reduce (/*Object*/ a, /*String*/ b) {
          b = b.split('=');
          if ($.isArray(a[b[0]])) {
            a[b[0]].push(b[1])
          } else if (typeof a[b[0]] === 'undefined' && b[1] != undefined) {
            a[b[0]] = decodeURIComponent(b[1].replace(/\+/g, '%20'));
          } else if (b[1] != undefined) {
            a[b[0]] = [a[b[0]], b[1]]
          }
          return a;
        }, {});  
      params["by"] = (params["by"] === undefined) ? 10 : parseInt(params["by"]);
      params["offset"] = 0;

      var $f = $('#query');
      for (var param in params) {
        field = $f.find('input[name='+param+']')[0] || $f.find('textarea[name='+param+']')[0] || $f.find('select[name='+param+']')[0];
          if (field === undefined) {
            continue;
          } else if (field.type === 'select') {
            var fieldvalue = params[param];
            $f.find('select[name='+param+']')[0].val( fieldvalue ).change();
          } else {
            field.value = params[param];
          }
      }

      params["before"] = moment(params["before"],"L LT").toJSON();
      if (params["before"] == undefined) delete params["before"]; 
      params["after"] = moment(params["after"],"L LT").toJSON();
      if (params["after"] == undefined) delete params["after"]; 


      //if (params['phone'] || params['ip'] || params['before'] || params['after']) {
        $('#data').removeClass('hide');
        getRows(params);
        $('#next').removeClass('hide');
      //}
    });

    </script>
</body>
</html>
